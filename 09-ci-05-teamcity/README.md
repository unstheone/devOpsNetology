# Домашнее задание к занятию 11 «Teamcity»

## Подготовка к выполнению

1. В Yandex Cloud создайте новый инстанс (4CPU4RAM) на основе образа `jetbrains/teamcity-server`.
2. Дождитесь запуска teamcity, выполните первоначальную настройку.![1.png](img%2F1.png)
3. Создайте ещё один инстанс (2CPU4RAM) на основе образа ``. Пропишите к нему переменную окружения `SERVER_URL: "http://<teamcity_url>:8111"`.![2.png](img%2F2.png)
4. Авторизуйте агент.![3.png](img%2F3.png)
5. Сделайте fork [репозитория](https://github.com/aragastmatb/example-teamcity).
6. Создайте VM (2CPU4RAM) и запустите [playbook](./infrastructure).

<details><summary>ansible-laybook...</summary>

```commandline
$ ansible-playbook site.yml -i inventory/cicd/hosts.yml 

PLAY [Get Nexus installed] ****************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ********************************************************************************************************************************************************************************************************************
The authenticity of host '51.250.75.179 (51.250.75.179)' can't be established.
ED25519 key fingerprint is SHA256:utv1Czrn4t619+wQq2glICUjzuBdVDX14T6ec26uPbA.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
ok: [nexus-01]

TASK [Create Nexus group] *****************************************************************************************************************************************************************************************************************
changed: [nexus-01]

TASK [Create Nexus user] ******************************************************************************************************************************************************************************************************************
changed: [nexus-01]

TASK [Install JDK] ************************************************************************************************************************************************************************************************************************
changed: [nexus-01]

TASK [Create Nexus directories] ***********************************************************************************************************************************************************************************************************
changed: [nexus-01] => (item=/home/nexus/log)
changed: [nexus-01] => (item=/home/nexus/sonatype-work/nexus3)
changed: [nexus-01] => (item=/home/nexus/sonatype-work/nexus3/etc)
changed: [nexus-01] => (item=/home/nexus/pkg)
changed: [nexus-01] => (item=/home/nexus/tmp)

TASK [Download Nexus] *********************************************************************************************************************************************************************************************************************
[WARNING]: Module remote_tmp /home/nexus/.ansible/tmp did not exist and was created with a mode of 0700, this may cause issues when running as another user. To avoid this, create the remote_tmp dir with the correct permissions
manually
changed: [nexus-01]

TASK [Unpack Nexus] ***********************************************************************************************************************************************************************************************************************
changed: [nexus-01]

TASK [Link to Nexus Directory] ************************************************************************************************************************************************************************************************************
changed: [nexus-01]

TASK [Add NEXUS_HOME for Nexus user] ******************************************************************************************************************************************************************************************************
changed: [nexus-01]

TASK [Add run_as_user to Nexus.rc] ********************************************************************************************************************************************************************************************************
changed: [nexus-01]

TASK [Raise nofile limit for Nexus user] **************************************************************************************************************************************************************************************************
changed: [nexus-01]

TASK [Create Nexus service for SystemD] ***************************************************************************************************************************************************************************************************
changed: [nexus-01]

TASK [Ensure Nexus service is enabled for SystemD] ****************************************************************************************************************************************************************************************
changed: [nexus-01]

TASK [Create Nexus vmoptions] *************************************************************************************************************************************************************************************************************
changed: [nexus-01]

TASK [Create Nexus properties] ************************************************************************************************************************************************************************************************************
changed: [nexus-01]

TASK [Lower Nexus disk space threshold] ***************************************************************************************************************************************************************************************************
skipping: [nexus-01]

TASK [Start Nexus service if enabled] *****************************************************************************************************************************************************************************************************
changed: [nexus-01]

TASK [Ensure Nexus service is restarted] **************************************************************************************************************************************************************************************************
skipping: [nexus-01]

TASK [Wait for Nexus port if started] *****************************************************************************************************************************************************************************************************
ok: [nexus-01]

PLAY RECAP ********************************************************************************************************************************************************************************************************************************
nexus-01                   : ok=17   changed=15   unreachable=0    failed=0    skipped=2    rescued=0    ignored=0  
```
</details>

## Основная часть

1. Создайте новый проект в teamcity на основе fork.
2. Сделайте autodetect конфигурации.![4.png](img%2F4.png)
3. Сохраните необходимые шаги, запустите первую сборку master.
4. Поменяйте условия сборки: если сборка по ветке `master`, то должен происходит `mvn clean deploy`, иначе `mvn clean test`.![6.png](img%2F6.png)
5. Для deploy будет необходимо загрузить [settings.xml](./teamcity/settings.xml) в набор конфигураций maven у teamcity, предварительно записав туда креды для подключения к nexus.![7.png](img%2F7.png)
6. В pom.xml необходимо поменять ссылки на репозиторий и nexus. `done`
7. Запустите сборку по master, убедитесь, что всё прошло успешно и артефакт появился в nexus.![8.png](img%2F8.png)![9.png](img%2F9.png)
8. Мигрируйте `build configuration` в репозиторий.![10.png](img%2F10.png)
9. Создайте отдельную ветку `feature/add_reply` в репозитории.![11.png](img%2F11.png)
10. Напишите новый метод для класса Welcomer: метод должен возвращать произвольную реплику, содержащую слово `hunter`.
``4b0b068bfe8faae38b6342cec64994cc93f4238f - ID коммита на Welcomer``
11. Дополните тест для нового метода на поиск слова `hunter` в новой реплике.
``b41783591b7d333c46df3dc8e2950d5bf9ae2535 - ID коммита на WelcomerTest``
12. Сделайте push всех изменений в новую ветку репозитория.
13. Убедитесь, что сборка самостоятельно запустилась, тесты прошли успешно.![12.png](img%2F12.png)
14. Внесите изменения из произвольной ветки `feature/add_reply` в `master` через `Merge`. `done`
15. Убедитесь, что нет собранного артефакта в сборке по ветке `master`.![13.png](img%2F13.png)
16. Настройте конфигурацию так, чтобы она собирала `.jar` в артефакты сборки.
17. Проведите повторную сборку мастера, убедитесь, что сбора прошла успешно и артефакты собраны.![14.png](img%2F14.png)
18. Проверьте, что конфигурация в репозитории содержит все настройки конфигурации из teamcity.
https://github.com/unstheone/example-teamcity/blob/master/.teamcity/Netology/buildTypes/Netology_Fork.xml
19. В ответе пришлите ссылку на репозиторий.

---